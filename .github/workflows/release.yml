name: Build, Package, Release (CeraRegularize)

on:
  push:
    tags:
      - "v*.*.*" # Example: v1.0.1

permissions:
  contents: write

jobs:
  build-pack-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # If you have global.json in repo, this will use it.
      # If you don't have global.json, change dotnet-version to the SDK you need.
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json
          dotnet-version: "9.0.x"

      - name: Set version from tag
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"          # e.g. v1.0.1
          $ver = $tag.TrimStart("v")               # e.g. 1.0.1
          "TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append
          "VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Tag: $tag"
          Write-Host "Version: $ver"

      - name: Restore dependencies
        run: dotnet restore

      - name: Restore dotnet tools (vpk)
        run: dotnet tool restore

      - name: Show dotnet tools
        run: dotnet tool list

      - name: Publish app (win-x64)
        run: dotnet publish -c Release -r win-x64 --self-contained false

      # IMPORTANT: Update packDir if your publish folder differs.
      - name: Pack with vpk (Squirrel artifacts)
        run: >
          dotnet tool run vpk -- pack
          --packId CeraRegularize
          --packVersion ${{ env.VERSION }}
          --packTitle "CeraRegularize"
          --packDir "bin\Release\net10.0-windows10.0.19041.0\win-x64\publish"
          --outputDir "ReleasePackages"

      - name: List ReleasePackages
        shell: pwsh
        run: |
          if (!(Test-Path "ReleasePackages")) { throw "ReleasePackages folder not found." }
          Get-ChildItem -Force "ReleasePackages" | Format-Table -AutoSize

      # Creates a GitHub Release and uploads all artifacts (exe/zip/nupkg/RELEASES/json)
      # This avoids GitHub's 100MB git file limit because these are release assets, not committed to git.
      - name: Create GitHub Release + Upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: CeraRegularize ${{ env.TAG }}
          generate_release_notes: true
          files: |
            ReleasePackages/*
